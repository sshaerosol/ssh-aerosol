
PROGRAM main
  USE SSHaerosol
  IMPLICIT NONE

  INTEGER :: nbins
  INTEGER :: nspecies
  INTEGER :: naero
  INTEGER :: itest
  INTEGER :: nlayers
  INTEGER :: iemis
  INTEGER :: j,it
  DOUBLE PRECISION :: duration,lat,lon,temp,pres,relh
  double precision,allocatable,dimension(:) :: Vlayers
  double precision,allocatable,dimension(:) :: number,diam_bins
  double precision,allocatable,dimension(:) :: gas_conc
  double precision,allocatable,dimension(:,:) :: aero_conc
  character (len=400) :: namelist_ssh
  character(len=40),allocatable,dimension(:) :: name_input_species
  integer,allocatable,dimension(:) :: index_species_ssh

  itest=-2
  do it=1,10*150*5
  if (itest==0) then
     ! Nucleation example
     print*,"Nucleation test case"    

     namelist_ssh="./namelist_modssh.ssh"     

     duration=3600.d0
     pres=1.01325e05
     temp=288.15d0
     relh=0.6d0

     iemis=1

     nbins=50
     allocate(diam_bins(nbins+1))
     diam_bins=(/1.0000000000000000E-03, 1.2022644346174130E-03, 1.4454397707459280E-03, 1.7378008287493760E-03, 2.0892961308540399E-03, 2.5118864315095799E-03, 3.0199517204020170E-03, 3.6307805477010140E-03, 4.3651583224016601E-03, 5.2480746024977272E-03, 6.3095734448019337E-03, 7.5857757502918377E-03, 9.1201083935590985E-03, 1.0964781961431851E-02, 1.3182567385564069E-02, 1.5848931924611141E-02, 1.9054607179632480E-02, 2.2908676527677741E-02, 2.7542287033381681E-02, 3.3113112148259113E-02, 3.9810717055349727E-02, 4.7863009232263859E-02, 5.7543993733715687E-02, 6.9183097091893658E-02, 8.3176377110267125E-02, 1.0000000000000001E-01, 1.2022644346174140E-01, 1.4454397707459279E-01, 1.7378008287493751E-01, 2.0892961308540400E-01, 2.5118864315095812E-01, 3.0199517204020171E-01, 3.6307805477010152E-01, 4.3651583224016621E-01, 5.2480746024977298E-01, 6.3095734448019380E-01, 7.5857757502918444E-01, 9.1201083935590987E-01, 1.0964781961431860E+00, 1.3182567385564070E+00, 1.5848931924611140E+00, 1.9054607179632490E+00, 2.2908676527677749E+00, 2.7542287033381689E+00, 3.3113112148259121E+00, 3.9810717055349771E+00, 4.7863009232263849E+00, 5.7543993733715766E+00, 6.9183097091893693E+00, 8.3176377110267090E+00, 1.0000000000000011E+01/)
     print*,diam_bins(:)

     call initialisation_modssh(namelist_ssh,iemis,naero,nspecies,nbins,diam_bins,nlayers,Vlayers)
     print*,naero,nspecies,nbins,nlayers
     print*,Vlayers

     allocate(number(nbins))
     allocate(gas_conc(nspecies))
     allocate(aero_conc(nbins,naero))

     number=0.d0
     gas_conc=0.d0
     aero_conc=0.d0
     gas_conc(5)=8.0d0
     aero_conc(:,4)=(/7.222506E-19, 1.191796E-17, 1.783646E-16, 2.421107E-15, 2.980732E-14, 3.328443E-13, 3.371117E-12, 3.096894E-11, 2.580500E-10, 1.950345E-09, 1.337071E-08, 8.314528E-08, 4.689924E-07, 2.399630E-06, 1.113844E-05, 4.714408E-05, 1.987428E-04, 1.190799E-03, 8.254623E-03, 3.246224E-02, 5.914383E-02, 6.289222E-02, 7.917661E-02, 1.392658E-01, 2.426590E-01, 3.854985E-01, 5.556413E-01, 7.265657E-01, 8.619621E-01, 9.278976E-01, 9.067632E-01, 8.053857E-01, 6.525903E-01, 4.879282E-01, 3.484007E-01, 2.601101E-01, 2.374289E-01, 2.873215E-01, 4.142062E-01, 6.217591E-01, 9.106726E-01, 1.273746E+00, 1.690945E+00, 2.127184E+00, 2.534756E+00, 2.860762E+00, 3.057965E+00, 3.095896E+00, 2.968541E+00, 2.695891E+00/)
     aero_conc(:,5)=(/3.095360E-19, 5.107696E-18, 7.644198E-17, 1.037617E-15, 1.277457E-14, 1.426476E-13, 1.444764E-12, 1.327240E-11, 1.105928E-10, 8.358622E-10, 5.730304E-09, 3.563369E-08, 2.009968E-07, 1.028413E-06, 4.773617E-06, 2.020461E-05, 8.517548E-05, 5.103422E-04, 3.537695E-03, 1.391239E-02, 2.534736E-02, 2.695381E-02, 3.393283E-02, 5.968534E-02, 1.039967E-01, 1.652136E-01, 2.381320E-01, 3.113853E-01, 3.694123E-01, 3.976704E-01, 3.886128E-01, 3.451653E-01, 2.796816E-01, 2.091121E-01, 1.493146E-01, 1.114758E-01, 1.017553E-01, 1.231378E-01, 1.775169E-01, 2.664682E-01, 3.902882E-01, 5.458911E-01, 7.246907E-01, 9.116503E-01, 1.086324E+00, 1.226041E+00, 1.310556E+00, 1.326812E+00, 1.272232E+00, 1.155382E+00/)

     !To create the coefficient repartition file
     ! call initialisation_repart_coeff(namelist_ssh)

     !Launch SSH
     print*,"Launch SSH-aerosol for nucleation test case"
     call launch_ssh_aerosolonly(namelist_ssh,iemis,naero,nbins,nspecies,duration,temp,pres,relh,gas_conc,aero_conc,number)
     print*,"SSH-aerosol suceeded"
     !call launch_ssh_aerosolonly(namelist_ssh,iemis,naero,nbins,nspecies,duration,temp,pres,relh,gas_conc,aero_conc,number)
     !print*,"C"

     print*,"Number concentrations: ",number
     print*,"Ammoniac concentration: ",gas_conc(5)
     print*,"Ammonium: ",aero_conc(:,5)

  else if (itest==-2) then
     print*,"Nucleation test case on 10 bins"

     nspecies=15
     allocate(name_input_species(nspecies))
     name_input_species=(/"DUST","NA","PPM","AnBlP","BiA0D","BiA1D","BiBmP","BiDER","BiNIT","BiPER","H2SO4","HCL","HNO3","NH3","WATER"/)

     namelist_ssh="./namelist_modssh2.ssh"
     
     duration=300.d0
     pres=83430.7257026565
     temp=274.842861723520
     relh=0.9699
     iemis=0
     nbins=10
     allocate(diam_bins(nbins+1))
     diam_bins=(/1.000000000000000E-002, 2.200710000000000E-002, 4.843125000000000E-002, 0.106583200000000, 0.234558600000000, 0.516195600000000, 1.13599700000000, 2.50000000000000, 5.00000000000000, 10.0000000000000, 40.0000000000000/)

     allocate(index_species_ssh(nspecies))
     call initialisation_modssh_spec(namelist_ssh,iemis,naero,nspecies,nbins,diam_bins,nlayers,Vlayers,name_input_species,index_species_ssh)

     allocate(number(nbins))
     allocate(gas_conc(nspecies))
     allocate(aero_conc(nbins,naero))

     number=0.d0
     gas_conc=(/0.000000000000000E+000, 0.000000000000000E+000, 0.000000000000000E+000, 3.495667859019675E-009, 0.193554051627941, 0.682188148088399, 5.899831502131484E-017, 2.706750203251961E-006, 1.371970248259396E-005, 2.824084152604930E-016, 2.261325884880494E-016, 7.312047280308424E-010, 3.112308355005624E-009, 3.020204926436138E-006, 0.000000000000000E+000/)
     gas_conc(:)=5.d0
     aero_conc(1,:)=(/1.660565472360303E-016,1.660565472360303E-016,3.819300586428696E-017,1.594142853465891E-016,2.989017850248545E-017,1.029550592863388E-016,5.895007426879075E-017,2.822961303012515E-016,2.789749993565308E-016,2.789749993565308E-016,2.258369042410012E-016,2.773144338841706E-016,3.918934514770315E-016,3.570215765574651E-016,2.989017850248545E-017/)
     aero_conc(2,:)=(/1.660565472360303E-016,1.660565472360303E-016,3.819300586428696E-017,1.594142853465891E-016,2.989017850248545E-017,1.029550592863388E-016,5.895007426879075E-017,2.822961303012515E-016,2.789749993565308E-016,2.789749993565308E-016,2.258369042410012E-016,2.773144338841706E-016,3.918934514770315E-016,3.570215765574651E-016,2.989017850248545E-017/)
     aero_conc(3,:)=(/1.660565472360303E-016,8.031532368814475E-004,3.819300586428696E-017,1.036478575412702E-002,2.989017850248545E-017,1.029550592863388E-016,5.895007426879075E-017,2.822961303012515E-016,2.789749993565308E-016,2.789749993565308E-016,2.258369042410012E-016,2.773144338841706E-016,3.918934514770315E-016,3.570215765574651E-016,2.989017850248545E-017/)
     aero_conc(4,:)=(/1.660565472360303E-016,9.821640336112977E-003,3.819300586428696E-017,0.126781172765974,2.989017850248545E-017,1.029550592863388E-016,5.895007426879075E-017,2.822961303012515E-016,2.789749993565308E-016,2.789749993565308E-016,2.258369042410012E-016,2.773144338841706E-016,3.918934514770315E-016,3.570215765574651E-016,2.989017850248545E-017/)
     aero_conc(5,:)=(/1.660565472360303E-016,9.837152609838862E-003,3.819300586428696E-017,0.126964111049529,2.989017850248545E-017,1.029550592863388E-016,5.895007426879075E-017,2.822961303012515E-016,2.789749993565308E-016,2.789749993565308E-016,2.258369042410012E-016,2.773144338841706E-016,3.918934514770315E-016,3.570215765574651E-016,2.989017850248545E-017/)
     aero_conc(6,:)=(/1.081723950801131E-003,8.252384194483554E-003,3.819300586428696E-017,0.106478456850325,2.989017850248545E-017,1.029550592863388E-016,5.895007426879075E-017,2.822961303012515E-016,2.789749993565308E-016,2.789749993565308E-016,2.258369042410012E-016,2.773144338841706E-016,3.918934514770315E-016,3.570215765574651E-016,2.989017850248545E-017/)
     aero_conc(7,:)=(/6.694620856799852E-003,1.660565472360303E-016,3.819300586428696E-017,1.594142853465891E-016,2.989017850248545E-017,1.029550592863388E-016,5.895007426879075E-017,2.822961303012515E-016,2.789749993565308E-016,2.789749993565308E-016,2.258369042410012E-016,2.773144338841706E-016,3.918934514770315E-016,3.570215765574651E-016,2.989017850248545E-017/)
     aero_conc(8,:)=(/5.879152223646606E-003,1.660565472360303E-016,3.819300586428696E-017,1.594142853465891E-016,2.989017850248545E-017,1.029550592863388E-016,5.895007426879075E-017,2.822961303012515E-016,2.789749993565308E-016,2.789749993565308E-016,2.258369042410012E-016,2.773144338841706E-016,3.918934514770315E-016,3.570215765574651E-016,2.989017850248545E-017/)
     aero_conc(9,:)=(/5.854909303090622E-003,1.660565472360303E-016,3.819300586428696E-017,1.594142853465891E-016,2.989017850248545E-017,1.029550592863388E-016,5.895007426879075E-017,2.822961303012515E-016,2.789749993565308E-016,2.789749993565308E-016,2.258369042410012E-016,2.773144338841706E-016,3.918934514770315E-016,3.570215765574651E-016,2.989017850248545E-017/)
     aero_conc(10,:)=(/1.660565472360303E-016,1.660565472360303E-016,3.819300586428696E-017,1.594142853465891E-016,2.989017850248545E-017,1.029550592863388E-016,5.895007426879075E-017,2.822961303012515E-016,2.789749993565308E-016,2.789749993565308E-016,2.258369042410012E-016,2.773144338841706E-016,3.918934514770315E-016,3.570215765574651E-016,2.989017850248545E-017/)

     print*,"Launch SSH-aerosol for nucleation test case"
     call launch_ssh_aerosolonly(namelist_ssh,iemis,naero,nbins,nspecies,duration,temp,pres,relh,gas_conc,aero_conc,number)
     print*,"SSH-aerosol suceeded"

  else if (itest==-1) then
     ! Nucleation example
     print*,"Nucleation test case on 49 bins"

     nspecies=14
     allocate(name_input_species(nspecies))
     name_input_species=(/"DUST","NA","PPM","BiA0D","BiA1D","BiBmP","BiDER","BiNIT","BiPER","H2SO4","HCL","HNO3","NH3","WATER"/)

     namelist_ssh="./namelist_modssh.ssh"     

     duration=3600.d0
     pres=1.01325e05
     temp=288.15d0
     relh=0.6d0

     iemis=1

     nbins=49
     allocate(diam_bins(nbins+1))
     diam_bins=(/1.0000000000000000E-03, 1.2022644346174130E-03, 1.4454397707459280E-03, 1.7378008287493760E-03, 2.0892961308540399E-03, 2.5118864315095799E-03, 3.0199517204020170E-03, 3.6307805477010140E-03, 4.3651583224016601E-03, 5.2480746024977272E-03, 6.3095734448019337E-03, 7.5857757502918377E-03, 9.1201083935590985E-03, 1.0964781961431851E-02, 1.3182567385564069E-02, 1.5848931924611141E-02, 1.9054607179632480E-02, 2.2908676527677741E-02, 2.7542287033381681E-02, 3.3113112148259113E-02, 3.9810717055349727E-02, 4.7863009232263859E-02, 5.7543993733715687E-02, 6.9183097091893658E-02, 8.3176377110267125E-02, 1.0000000000000001E-01, 1.2022644346174140E-01, 1.4454397707459279E-01, 1.7378008287493751E-01, 2.0892961308540400E-01, 2.5118864315095812E-01, 3.0199517204020171E-01, 3.6307805477010152E-01, 4.3651583224016621E-01, 5.2480746024977298E-01, 6.3095734448019380E-01, 7.5857757502918444E-01, 9.1201083935590987E-01, 1.0964781961431860E+00, 1.3182567385564070E+00, 1.5848931924611140E+00, 1.9054607179632490E+00, 2.2908676527677749E+00, 2.7542287033381689E+00, 3.3113112148259121E+00, 3.9810717055349771E+00, 4.7863009232263849E+00, 5.7543993733715766E+00, 6.9183097091893693E+00, 8.3176377110267090E+00/)
          diam_bins=(/1.0000000000000000E-03, 1.2022644346174130E-03, 1.4454397707459280E-03, 1.7378008287493760E-03, 2.0892961308540399E-03, 2.5118864315095799E-03, 3.0199517204020170E-03, 3.6307805477010140E-03, 4.3651583224016601E-03, 5.2480746024977272E-03, 6.3095734448019337E-03, 7.5857757502918377E-03, 9.1201083935590985E-03, 1.0964781961431851E-02, 1.3182567385564069E-02, 1.5848931924611141E-02, 1.9054607179632480E-02, 2.2908676527677741E-02, 2.7542287033381681E-02, 3.3113112148259113E-02, 3.9810717055349727E-02, 4.7863009232263859E-02, 5.7543993733715687E-02, 6.9183097091893658E-02, 8.3176377110267125E-02, 1.0000000000000001E-01, 1.2022644346174140E-01, 1.4454397707459279E-01, 1.7378008287493751E-01, 2.0892961308540400E-01, 2.5118864315095812E-01, 3.0199517204020171E-01, 3.6307805477010152E-01, 4.3651583224016621E-01, 5.2480746024977298E-01, 6.3095734448019380E-01, 7.5857757502918444E-01, 9.1201083935590987E-01, 1.0964781961431860E+00, 1.3182567385564070E+00, 1.7E+00, 1.9054607179632490E+00, 2.2908676527677749E+00, 2.7542287033381689E+00, 3.3113112148259121E+00, 3.9810717055349771E+00, 4.7863009232263849E+00, 5.7543993733715766E+00, 6.9183097091893693E+00, 8.3176377110267090E+00/)
     print*,diam_bins(:)
     allocate(index_species_ssh(nspecies))
     call initialisation_modssh_spec(namelist_ssh,iemis,naero,nspecies,nbins,diam_bins,nlayers,Vlayers,name_input_species,index_species_ssh)
     print*,naero,nspecies,nbins,nlayers
     print*,Vlayers

     allocate(number(nbins))
     allocate(gas_conc(nspecies))
     allocate(aero_conc(nbins,naero))
     do j=1,nspecies
        print*,j,index_species_ssh(j),trim(name_input_species(j))
     enddo

     number=0.d0
     gas_conc=0.d0
     aero_conc=0.d0
     gas_conc(index_species_ssh(13))=8.0d0
     aero_conc(:,index_species_ssh(10))=(/7.222506E-19, 1.191796E-17, 1.783646E-16, 2.421107E-15, 2.980732E-14, 3.328443E-13, 3.371117E-12, 3.096894E-11, 2.580500E-10, 1.950345E-09, 1.337071E-08, 8.314528E-08, 4.689924E-07, 2.399630E-06, 1.113844E-05, 4.714408E-05, 1.987428E-04, 1.190799E-03, 8.254623E-03, 3.246224E-02, 5.914383E-02, 6.289222E-02, 7.917661E-02, 1.392658E-01, 2.426590E-01, 3.854985E-01, 5.556413E-01, 7.265657E-01, 8.619621E-01, 9.278976E-01, 9.067632E-01, 8.053857E-01, 6.525903E-01, 4.879282E-01, 3.484007E-01, 2.601101E-01, 2.374289E-01, 2.873215E-01, 4.142062E-01, 6.217591E-01, 9.106726E-01, 1.273746E+00, 1.690945E+00, 2.127184E+00, 2.534756E+00, 2.860762E+00, 3.057965E+00, 3.095896E+00, 2.968541E+00/)
     aero_conc(:,index_species_ssh(13))=(/3.095360E-19, 5.107696E-18, 7.644198E-17, 1.037617E-15, 1.277457E-14, 1.426476E-13, 1.444764E-12, 1.327240E-11, 1.105928E-10, 8.358622E-10, 5.730304E-09, 3.563369E-08, 2.009968E-07, 1.028413E-06, 4.773617E-06, 2.020461E-05, 8.517548E-05, 5.103422E-04, 3.537695E-03, 1.391239E-02, 2.534736E-02, 2.695381E-02, 3.393283E-02, 5.968534E-02, 1.039967E-01, 1.652136E-01, 2.381320E-01, 3.113853E-01, 3.694123E-01, 3.976704E-01, 3.886128E-01, 3.451653E-01, 2.796816E-01, 2.091121E-01, 1.493146E-01, 1.114758E-01, 1.017553E-01, 1.231378E-01, 1.775169E-01, 2.664682E-01, 3.902882E-01, 5.458911E-01, 7.246907E-01, 9.116503E-01, 1.086324E+00, 1.226041E+00, 1.310556E+00, 1.326812E+00, 1.272232E+00/)

     !To create the coefficient repartition file
     ! call initialisation_repart_coeff(namelist_ssh)

     !Launch SSH
     print*,"Launch SSH-aerosol for nucleation test case"
     call launch_ssh_aerosolonly(namelist_ssh,iemis,naero,nbins,nspecies,duration,temp,pres,relh,gas_conc,aero_conc,number)
     print*,"SSH-aerosol suceeded"
     !call launch_ssh_aerosolonly(namelist_ssh,iemis,naero,nbins,nspecies,duration,temp,pres,relh,gas_conc,aero_conc,number)
     !print*,"C"

     print*,"Number concentrations: ",number
     print*,"Ammoniac concentration: ",gas_conc(index_species_ssh(13))
     print*,"Ammonium: ",aero_conc(:,index_species_ssh(13))

  else ! Visco 5 POAmP test case     
     
     namelist_ssh="./namelist_modssh_visco.ssh"
     
     duration=2419200.0d0 !3600.d0
     pres=1.01325e05
     temp=298.0
     relh=0.1d0

     iemis=0
     nbins=1
     allocate(diam_bins(nbins+1))
     diam_bins=(/0.32D+00, 0.5D+00/)
     call initialisation_modssh(namelist_ssh,iemis,naero,nspecies,nbins,diam_bins,nlayers,Vlayers)
     print*,naero,nspecies,nbins,nlayers
     print*,Vlayers
         
     allocate(number(nbins))
     allocate(gas_conc(nspecies))
     allocate(aero_conc(nbins,naero))

     number=0.d0
     gas_conc=0.d0
     aero_conc=0.d0
     
     gas_conc(29)=5.0d0
     gas_conc(25)=0.01d0
     aero_conc(1,93:97)=5.0d0*Vlayers(:)
     print*,aero_conc(1,93:97)

     print*,"Launch SSH-aerosol for nucleation test case"
     call launch_ssh_aerosolonly(namelist_ssh,iemis,naero,nbins,nspecies,duration,temp,pres,relh,gas_conc,aero_conc,number)
     print*,"SSH-aerosol suceeded"

     print*,"POAmP gas concentration: ",gas_conc(29)
     print*,"POAmP aerosol concentration: ",sum(aero_conc(1,113:117))
     print*,"SOAlP aerosol concentration: ",sum(aero_conc(1,93:97))
     print*,"Number: ",number
  endif
  deallocate(number)
  deallocate(gas_conc)
  deallocate(aero_conc)
  deallocate(name_input_species)
  deallocate(diam_bins)
  deallocate(index_species_ssh)
  enddo
  
END PROGRAM main
