#!/bin/bash

for i in "$@"
do
case $i in
# Read the option for Chemistry kinetic mechanism.
# Accepted values: racm, racm2, cb05, melchior2
# Default: chemistry=cb05
    -c=*|--chemistry=*)
    chemistry="${i#*=}"
    shift
    ;;
# Read the option to generate a shared lib
# Accepted values: yes or no
# Default: sharedlib = no
    -s=*|--sharedlib=*)      
    sharedlib="${i#*=}"        
    shift                       
    ;;                              
# Read the option to choose whether openmp is taken into account.
# Accepted values: yes or no
# Default: openmp = no
    -o=*|--openmp=*)
    openmp="${i#*=}"
    shift
    ;;
# Read the option to choose which compile mode is used.
# Accepted values: fast, debug
# Default: profile = fast    
    -p=*|--profile=*)
    profile="${i#*=}"
    shift
    ;;
# Read the option to choose whether the gas-phase chemistry
# need to be combined with the h2o mechanism.
# Accepted values: h2o, user, no
# Default: iscombining = no    
    -b=*|--iscombining=*)
    iscombining="${i#*=}"
    shift
    ;;
    
# Read the option to use genoa
# Accepted values: fast, complete, no
# Default: genoa = no    
    -g=*|--genoa=*)
    genoa="${i#*=}"
    shift
    ;;

esac
done

ulimit -s unlimited
# Path to blitz and netcdf libraries
#export LD_LIBRARY_PATH=/home/cereaadm/usr/local/lib:$LD_LIBRARY_PATH
# Path to blitz and netcdf files
#export CPLUS_INCLUDE_PATH=/home/cereaadm/usr/local/include:$CPLUS_INCLUDE_PATH
# path to netcdf.mod
#export F90FLAGS=-I/home/cereaadm/usr/local/include:$F90FLAGS
# path to swig
#export SWIG=/home/cereaadm/usr/local/bin/swig

if [[ $genoa == "fast" || $genoa == "complete" ]]; then
    # used for genoa 
    # some changes are irreversible

    # active tag
    echo "GENOA version : $genoa"
    
    # default paramters to use genoa - change here
    chemistry="genoa"
    
    if [ -z $openmp ]; then
        openmp="no"
    fi
    echo "OpenMP: $openmp"

    sharedlib="no"                
    profile="fast"                
    iscombining="no"
    
    # Check folder exists
    #if [ ! -d "src/include/genoa" ]; then
    #    echo "Error: Folder 'src/include/genoa' does not exist."
    #    exit 1
    #fi
    
else # default no genoa

    # default not use genoa settings                  
    genoa="no"

    # not used for genoa 
    if [ -z $chemistry ]; then
        chemistry="cb05"
    fi
    # echo "Chemistry: $chemistry"

    if [ -z $openmp ]; then
        openmp="no"
    fi
    echo "OpenMP: $openmp"

    if [ -z $sharedlib ]; then                     
        sharedlib="no"                
    fi
    echo "SharedLib: $sharedlib"

    if [ -z $profile ]; then                     
        profile="fast"                
    fi
    echo "Compiling profile : $profile"

    if [ -z $iscombining ]; then                     
        iscombining="no"
    else
        # Check whether the given option is accepted.
        if [[ $iscombining != "h2o" && $iscombining != "user" ]]; then
            echo "Accepted values are 'h2o' and 'user'."
            echo "compile -b=h2O -c=cb05-ozone"
            echo "compile -b=user -c=cb05-ozone"
            exit 0                
        fi
    fi

    if [[ $iscombining == "h2o" || $iscombining == "user" ]]; then
        # Check if a mechanism without h2o is used.
        if [ $chemistry != "cb05-ozone" ]; then
            echo "Please use cb05-ozone as the chemistry mechanism."
            echo "compile -b=$iscombining -c=cb05-ozone"
            exit 0
        else
            cd src/include/CHEMISTRY/$chemistry
            cwd=$PWD
            rm -rf combine_files.py replacement_species.py user_defined_scheme.py
            ln -s ../../../../tools/combine_files.py
            ln -s ../../../../tools/replacement_species.py
            ln -s ../../../../tools/user_defined_scheme.py
            (
                set -e
                python3 combine_files.py _ciCB05_poa.species CB05_poa_nospack.reactions $iscombining
            )
            errorCode=$?
            if [ $errorCode -ne 0 ]; then
                exit $errorCode
            fi
            
            cd ../../../../
        fi
    fi
fi

file="ssh-aerosol"
rm -f $file

./cleantmp $chemistry

#=== List of scons options ===
# profile: fast, debug (default: fast)
# intel: yes or no (default: no)
# line: yes or no (default: no)
# mode_cpp: strict or permissive (default: strict)
# mode_fortran: strict or permissive (default: permissive)
# openmp: yes or no (default: no)
# mpi: yes or no (default: no)
#=============================

cd src
scons -j8 profile=$profile chemistry=$chemistry openmp=$openmp sharedlib=$sharedlib genoa=$genoa

cd ..
ln -s src/ssh-aerosol ssh-aerosol

if [[ $iscombining != "no" ]]; then
    echo 
    echo "New files have been generated."
    echo "Please use these files in namelist.ssh"
    echo "--- reactions: $cwd/combined_reactions.dat"
    echo "--- gas-phase speices: $cwd/species-list-user.dat"
    echo "--- aerosol species: $cwd/species-list-aer-user.dat"
    echo
fi

# if [[ $genoa != "fast" && $genoa != "complete" ]]; then # not used for genoa to save time
#     # Make a link to "species-list.dat" containing the species list.
#     # This file is automatically generated by SPACK.
#     cd species-list
#     file="species-list.dat"
#     if [ -h $file ] 
#     then
#         mv $file $file.bck
#     fi
#     ln -s ../src/include/CHEMISTRY/$chemistry/$file
# fi
